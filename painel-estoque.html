<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Estoque de Vacinas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #121212;
      --text: #f1f1f1;
      --highlight: #0d6efd;
    }
    body {
      padding: 2rem;
      background-color: var(--bg);
      color: var(--text);
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      background-color: #1e1e1e;
      color: var(--text);
      overflow: hidden;
    }
    .card-header {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .card-body.scrollable {
      max-height: 250px;
      overflow-y: auto;
    }
    .card-body.scrollable-lg {
      max-height: 400px;
      overflow-y: auto;
    }
    .btn-3d {
      background-color: var(--highlight);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.8rem;
      font-weight: bold;
      box-shadow: 0 4px #0b5ed7;
      transition: all 0.2s ease-in-out;
      cursor: pointer;
    }
    .btn-3d:hover {
      box-shadow: 0 2px #0a53be;
      transform: translateY(1px);
    }
    .btn-3d:active {
      box-shadow: 0 1px #084298;
      transform: translateY(2px);
    }
    .status-quase td, .status-quase td span {
      animation: blink-yellow 2s infinite;
    }
    .status-vencida td, .status-vencida td span {
      animation: blink-red 2s infinite;
    }
    @keyframes blink-yellow {
      0%, 100% { background-color: #b58e00; }
      50% { background-color: #ffc107; }
    }
    @keyframes blink-red {
      0%, 100% { background-color: #8b1a1a; }
      50% { background-color: #dc3545; }
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="text-center mb-4 text-light">📊 Painel de Estoque de Vacinas</h2>

    <div class="row g-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-primary text-white">💉 Vacinas em Uso</div>
          <div class="card-body scrollable-lg">
            <table class="table table-bordered table-hover table-sm mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Vacina</th>
                  <th>Lote</th>
                  <th>Laboratório</th>
                  <th>Quantidade</th>
                  <th>Validade</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="tabela-estoque"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-danger text-white">🚨 Estoque Baixo</div>
          <div class="card-body scrollable p-0">
            <table class="table table-sm table-striped table-hover mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Vacina</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="tabela-baixo-estoque"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-md-6 col-lg-4">
        <div class="card">
          <div class="card-header bg-dark text-white">📦 Resumo por Vacina</div>
          <div class="card-body scrollable p-0">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Vacina</th>
                  <th>Total de Doses</th>
                </tr>
              </thead>
              <tbody id="tabela-resumo"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Registro de Saída -->
  <div class="modal fade" id="saidaVacinaModal" tabindex="-1" aria-labelledby="saidaVacinaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content text-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="saidaVacinaModalLabel">Registrar Saída de Vacina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="form-saida">
            <div class="mb-3">
              <label for="vacinaSelect" class="form-label">Vacina</label>
              <select class="form-select" id="vacinaSelect" required></select>
            </div>
            <div class="mb-3">
              <label for="loteSelect" class="form-label">Lote</label>
              <select class="form-select" id="loteSelect" required></select>
            </div>
            <div class="mb-3">
              <label for="quantidadeUsada" class="form-label">Quantidade Usada</label>
              <input type="number" class="form-control" id="quantidadeUsada" min="1" required />
            </div>
            <div class="mb-3">
              <label for="responsavel" class="form-label">Responsável</label>
              <input type="text" class="form-control" id="responsavel" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Registrar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Botão Flutuante -->
  <button class="btn btn-3d position-fixed bottom-0 end-0 m-4" onclick="abrirModalSaida()">
    ➖ Registrar Saída
  </button>

  <script>
    let dadosEstoqueGlobal = [];

    async function carregarDados() {
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbxbGCi76XzJOEQCsvs5mhb4mLpVaGNE7sKxs6yTzzPZnnrqY7N3ubDO4WL6r0ZJzdi6FA/exec");
        const json = await response.json();
        dadosEstoqueGlobal = json.data;

        const tabelaEstoque = document.getElementById("tabela-estoque");
        const tabelaResumo = document.getElementById("tabela-resumo");
        const tabelaBaixo = document.getElementById("tabela-baixo-estoque");

        tabelaEstoque.innerHTML = "";
        tabelaResumo.innerHTML = "";
        tabelaBaixo.innerHTML = "";

        json.data.forEach(item => {
          const linha = document.createElement("tr");
          if (item.status.includes("VENCIDA")) linha.classList.add("status-vencida", "text-white");
          else if (item.status.includes("QUASE")) linha.classList.add("status-quase", "text-dark");

          linha.innerHTML = `
            <td>${item.vacina}</td>
            <td>${item.lote}</td>
            <td>${item.laboratorio || "-"}</td>
            <td>${item.quantidade}</td>
            <td>${item.validade}</td>
            <td><span class="badge ${item.status.includes('VENCIDA') ? 'bg-danger' : item.status.includes('QUASE') ? 'bg-warning text-dark' : 'bg-success'}">${item.status}</span></td>
            <td><button class="btn-3d" onclick="abrirModalSaida()">Ver</button></td>
          `;
          tabelaEstoque.appendChild(linha);
        });

        json.resumo.forEach(item => {
          const linhaResumo = document.createElement("tr");
          linhaResumo.innerHTML = `<td>${item.vacina}</td><td>${item.total}</td>`;
          tabelaResumo.appendChild(linhaResumo);

          if (item.total <= 5) {
            const linhaBaixo = document.createElement("tr");
            linhaBaixo.innerHTML = `<td>${item.vacina}</td><td>${item.total}</td>`;
            tabelaBaixo.appendChild(linhaBaixo);
          }
        });
      } catch (e) {
        console.error("Erro ao carregar dados da API:", e);
      }
    }

    function abrirModalSaida() {
      const modal = new bootstrap.Modal(document.getElementById('saidaVacinaModal'));
      modal.show();

      const vacinaSelect = document.getElementById('vacinaSelect');
      vacinaSelect.innerHTML = '<option value="">Selecione a vacina</option>';
      const vacinas = [...new Set(dadosEstoqueGlobal.map(item => item.vacina))];
      vacinas.forEach(vacina => {
        const option = document.createElement('option');
        option.value = vacina;
        option.textContent = vacina;
        vacinaSelect.appendChild(option);
      });

      document.getElementById('loteSelect').innerHTML = '<option value="">Selecione o lote</option>';
    }

    document.getElementById('vacinaSelect').addEventListener('change', function () {
      const loteSelect = document.getElementById('loteSelect');
      loteSelect.innerHTML = '<option value="">Selecione o lote</option>';
      const vacinaSelecionada = this.value;
      const lotesUnicos = [
        ...new Set(
          dadosEstoqueGlobal
            .filter(item => item.vacina === vacinaSelecionada)
            .map(item => item.lote)
        )
      ];
      lotesUnicos.forEach(lote => {
        const option = document.createElement('option');
        option.value = lote;
        option.textContent = lote;
        loteSelect.appendChild(option);
      });
    });

    document.getElementById('form-saida').addEventListener('submit', async function (e) {
      e.preventDefault();
      const vacina = document.getElementById('vacinaSelect').value;
      const lote = document.getElementById('loteSelect').value;
      const quantidade = document.getElementById('quantidadeUsada').value;
      const responsavel = document.getElementById('responsavel').value;

      if (!vacina || !lote || !quantidade || !responsavel) {
        alert("Preencha todos os campos.");
        return;
      }

      const payload = { vacina, lote, quantidade: Number(quantidade), responsavel };

      try {
        const resposta = await fetch('https://script.google.com/macros/s/AKfycbxbGCi76XzJOEQCsvs5mhb4mLpVaGNE7sKxs6yTzzPZnnrqY7N3ubDO4WL6r0ZJzdi6FA/exec', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (resposta.ok) {
          mostrarMensagem("✅ Saída registrada com sucesso!", "success");
          document.getElementById('form-saida').reset();
          bootstrap.Modal.getInstance(document.getElementById('saidaVacinaModal')).hide();
          carregarDados();
        } else {
          mostrarMensagem("❌ Erro ao registrar saída!", "danger");
        }
      } catch (err) {
        console.error(err);
        mostrarMensagem("❌ Erro na comunicação com o servidor!", "danger");
      }
    });

    document.addEventListener("DOMContentLoaded", carregarDados);
    
    function mostrarMensagem(texto, tipo) {
      const corpoMensagem = document.getElementById("mensagemCorpo");
      corpoMensagem.innerHTML = texto;
    
      const modal = new bootstrap.Modal(document.getElementById("mensagemModal"));
      const modalElement = document.getElementById("mensagemModal");
    
      modalElement.classList.remove("text-bg-success", "text-bg-danger", "text-bg-warning");
      modalElement.querySelector(".modal-content").className = `modal-content text-bg-${tipo}`;
      
      modal.show();
    
      setTimeout(() => {
        modal.hide();
      }, 3000); // Fecha após 3 segundos
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Modal de Mensagem -->
  <div class="modal fade" id="mensagemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content text-bg-success text-center p-4">
        <div id="mensagemCorpo" class="fw-bold fs-5">Mensagem</div>
      </div>
    </div>
  </div>
</body>
</html>
